---
title: "RSNA 2022 3rd Place Solution"
emoji: "ğŸ“‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["kaggle",]
published: true
---

# Introduction

- RSNA 2022 3rd place solution ã®ã¾ã¨ã‚è¨˜äº‹
  - å‡ºå…¸ï¼šhttps://www.kaggle.com/competitions/rsna-2022-cervical-spine-fracture-detection/discussion/362643

# æ¦‚è¦

- bounding box ãŒä¸ãˆã‚‰ã‚Œã¦ã„ã‚‹ãŒãã‚Œã‚’ä½¿ç”¨ã›ãšã€segmentation ã ã‘ã‚’ä½¿ç”¨ã—ãŸ
- ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
  - C1-C7 vertebrae ã® bbox ã‚’ä½œæˆ
  - slice level ã® vertabrae ratio ã‚’ä½œæˆ
  - slice ã”ã¨ã® vertebrae ã¨ fracture ãƒ©ãƒ™ãƒ«ã‚’å­¦ç¿’
  - study level vertebrea features ã‚’ã•ã‚‰ã«å­¦ç¿’ 

- è³‡æ–™
  - [google ã‚¹ãƒ©ã‚¤ãƒ‰](https://docs.google.com/presentation/d/1lS4yOTJT4EyaCjODGIO811RGex9jKQdZypzOjY_jxDA/edit#slide=id.g17a663b7f8b_0_620)

# å„ã‚¹ãƒ†ãƒ¼ã‚¸ã®è©³ç´°

## Stage-1

bounding box ã®å†æ§‹æˆã‚’å®Ÿæ–½

- train_bounding_box.csv ã¯ `StudyInstanceUID` ã€€ã”ã¨ã® bbox æƒ…å ±ã‚’ã‚‚ã£ã¦ã„ã‚‹
  - ãŸã ã—å…¨ã‚¹ãƒ©ã‚¤ã‚¹ã«å¯¾ã—ã¦ä¸ãˆã‚‰ã‚Œã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªã„
  - ã“ã‚Œã‚’ study level labels ã¨å‘¼ã‚“ã§ã„ã‚‹

```python
print(len(df.query('StudyInstanceUID=="1.2.826.0.1.3680043.10051"')))
print(len(glob.glob("/kaggle/input/rsna-2022-cervical-spine-fracture-detection/train_images/1.2.826.0.1.3680043.10051/*.dcm")))
# 16
# 272
```

- ãã“ã§å„ã‚¹ãƒ©ã‚¤ã‚¹å˜ä½ã§ã® bbox æƒ…å ±ã‚’å‡ºåŠ›ã™ã‚‹ãŸã‚ã«ã€segmentation æƒ…å ±ã‚’ä½¿ç”¨ã—ãŸã®ã ã¨æ€ã‚ã‚Œã‚‹
  - segmentation æƒ…å ±ã¯å…¨ã‚¹ãƒ©ã‚¤ã‚¹ï¼ˆtraining data ã® subset ã§ã¯ã‚ã‚‹ãŒï¼‰ã«å¯¾ã—ã¦ä¸ãˆã‚‰ã‚Œã¦ã„ã‚‹ã®ã§ã€segmentation ã‹ã‚‰ bbox æƒ…å ±ã‚’å¼•ãå‡ºã—ã¦ ground truth ã¨ã—ã¦ã„ã‚‹
  - `x0, y0, x1, y1, has_bbox` ã‚’äºˆæ¸¬ã—ãŸ
  - åº§æ¨™ç‚¹ã«ã¯ RMSEã€has_bbox ã«ã¯ BCE loss ã‚’ä½¿ç”¨
- segmentation map (87 study id) ã‚’ä½¿ã£ã¦ 2.5D + 1D RNN ã‚’å­¦ç¿’ã—ãŸ

- ãƒ‡ãƒ¼ã‚¿ã¯ nii ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­ã«æ¬¡å…ƒã¨ã—ã¦ segmentation æƒ…å ±ãŒè©°ã¾ã£ã¦ã„ã‚‹
```python
for fname in glob.glob("/kaggle/input/rsna-2022-cervical-spine-fracture-detection/segmentations/*.nii"):
    a = nib.load(fname).get_fdata()
    b = glob.glob(f'/kaggle/input/rsna-2022-cervical-spine-fracture-detection/train_images/{fname.split("/")[-1].replace(".nii","")}/*.dcm')
    
    print(a.shape, len(b))
``` 

- äºˆæ¸¬ã™ã‚‹ã‚¹ãƒ©ã‚¤ã‚¹ãƒ¬ãƒ™ãƒ«ã® bbox ã‚’ãã®ã¾ã¾ä½¿ç”¨ã™ã‚‹ã®ã§ã¯ãªãã€`StudyInstanceUID` ã®ä¸­ã§æœ€ã‚‚å¤§ããª bbox ã§å„ã‚¹ãƒ©ã‚¤ã‚¹ã‚’ã‚¯ãƒ­ãƒƒãƒ—ã™ã‚‹ã‚ˆã†ã«ã—ãŸã¨ã®ã“ã¨


## Stage-2

- z-axis æ–¹å‘ã« 32* 3 ã‚¹ãƒ©ã‚¤ã‚¹ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å–å¾—
  - ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ—ã—ãªãŒã‚‰ï¼ˆéš£æ¥ã™ã‚‹3ã¤ã®ã‚¹ãƒ©ã‚¤ã‚¹ã‚’å–å¾—ã—ã¤ã¤ï¼‰ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã™ã‚‹
  - https://github.com/darraghdog/RSNA22/blob/main/data/ds_dh_seg_2C.py
  
```python
imgls = [cv2.merge(imgls[i:i + 3]) for i in range(0, len(imgls), 3)]
```

- ãƒ©ãƒ³ãƒ€ãƒ ãªã‚¹ãƒ©ã‚¤ã‚¹ã§ã¯ fracture ãŒãªã„ã®ã§ã€ãƒãƒƒãƒã‚µã‚¤ã‚ºã‚’å¤§ããã—ã¦ã€å„ãƒãƒƒãƒã«æœ¬å½“ã«å­¦ç¿’ã—ãŸã„æƒ…å ±ãŒä¹—ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹
  - resnet50dã€sersenext50ã‚’ä½¿ç”¨
  - 1 fold 9æ™‚é–“ç¨‹åº¦ã®å­¦ç¿’æ™‚é–“
- CNN + GAP (Global Average Pooling), LSTM, Dense
- slice vertebrae label ã‚’å­¦ç¿’ã—ã¦ã„ã‚‹


- ãƒ¢ãƒ‡ãƒ«æ¦‚è¦
  - CNNã¨LSTM ã‚’åˆæœŸåŒ–ã—ã¦ã„ã‚‹

```python
self.backbone = timm.create_model('resnest50d')
hidden_size = self.backbone.fc.in_features # 2048
self.backbone.fc = torch.nn.Identity()
self.rnn = nn.LSTM(hidden_size, hidden_size, batch_first=True,  bidirectional=True)
```

- forward
  - ã¾ãšãƒ‡ãƒ¼ã‚¿æ§‹æˆã¨ã—ã¦ã€batch size, seuqence length, in_channs, height, widht ã«ãªã£ã¦ã„ã‚‹ã€‚
  - 32 ã¯ã‚¹ãƒ©ã‚¤ã‚¹ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å–å¾—ã™ã‚‹ã‚‚ã®ã§ã€overlap ã‚’ã‚†ã‚‹ã—ãªãŒã‚‰é¸æŠã—ãŸå„ã‚¹ãƒ©ã‚¤ã‚¹ã«å¯¾ã—ã¦éš£æ¥ã™ã‚‹ã‚¹ãƒ©ã‚¤ã‚¹ã‚’å–å¾—ã—ã¦ã„ã‚‹ï¼ˆ$32, 3$ ã®æ„å‘³ï¼‰
  - ãã®ã¾ã¾ã ã¨ resnet ã«å…¥ã‚Œã‚‰ã‚Œãªã„ã®ã§ `view` ã§ä¿®æ­£ã—ã¦ã„ã‚‹ï¼ˆbs=64, in_chans=3, 512, 512ã®ç”»åƒæƒ…å ±ã¨ã—ã¦æ‰±ã†ã“ã¨ã«ãªã‚‹ï¼‰
  - å‡ºã¦ããŸ embedding ã®æƒ…å ±ã‚’ä¿®æ­£ã—ã¦ LSTM ï¼ˆ=RNNï¼‰ã«å…¥åŠ›ã§ãã‚‹å½¢å¼ã«ã—ã¦ã„ã‚‹
  - ã“ã†ã™ã‚‹ã“ã¨ã§ã€æœ¬æ¥ã¯ $(2, 3, 512, 512)$ ã®ç”»åƒã‚’CNNã« 32å›é€šã—ã¦...ã¨ã„ã†ã“ã¨ã‚’ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŒã€ã†ã¾ã„ã“ã¨æ¬¡å…ƒã‚’æ‰±ã†ã“ã¨ã§1å›ã® fowardã§æ¸ˆã¾ã›ã¦ã„ã‚‹

```python
batchsize, seqlen, ch, h, w = batch['image'].shape # (2,32,3,512,512)
x = batch['image'].view(-1, ch, h, w) # (64,3,512,512)
emb = self.backbone(x) #  (64,2048)
emb = emb.view(batchsize, seqlen, -1) #&nbsp;(2, 32 ,2048)
logits = self.rnn(emb)[0] # (2, 32 , 4096)
```


# é›‘è¨˜

- StratifiedKFold ã™ã‚‹ã¨ãã® split ã—ãŸ df ã¯ä¿å­˜ã—ã¦ãŠã„ãŸã»ã†ãŒå†ç¾æ€§çš„ã«ã‚ˆã„ã‹ã‚‚ã—ã‚Œãªã„
- `glob.glob("**/*.png", recursive=True)` ã§ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥ä¸‹ã®ã™ã¹ã¦ã®png ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã§ãã‚‹
- `.nii` ãƒ‡ãƒ¼ã‚¿ã¯ `nibabel.load(...).get_fdata()` ã§èª­ã¿è¾¼ã‚ã‚‹
- ã‚·ãƒ¼ãƒ‰å€¤å›ºå®šï¼š

```python
def set_seed(seed=1234):
    random.seed(seed)
    os.environ["PYTHONHASHSEED"] = str(seed)
    np.random.seed(seed)
    torch.manual_seed(seed)
    torch.cuda.manual_seed(seed)
    torch.backends.cudnn.deterministic = False
    torch.backends.cudnn.benchmark = True
```

- CNN ã¨ RNN ã¯ã©ã†ã„ã†æ„Ÿã˜ã«ã—ã¦ã„ã‚‹ã®ã‹ã¨æ€ã£ãŸãŒã€`view` ã‚’ã†ã¾ã„ã“ã¨ä½¿ã£ã¦ã„ã‚‹ã®ã ãªã€‚ã€Œã“ã®æ¬¡å…ƒã«ã¯ã“ã®æ„å‘³ã‚’ã‚‚ãŸã›ã‚‹ã€ãã‚‰ã„ã®è»½ã„æ°—æŒã¡ã§ï¼ˆæ˜ç¤ºçš„ã«ä¸ãˆãªãã¦ã‚‚ï¼‰ã„ã„ã®ã ãª